{
  "appConfig": {},
  "application": "opsmx-gitops",
  "description": "go to this url for more details in the Readme",
  "keepWaitingPipelines": false,
  "lastModifiedBy": "admin",
  "limitConcurrent": true,
  "name": "byos-helm-upgrade-preview",
  "parameterConfig": [
    {
      "default": "hiu",
      "description": "kunernetes namespace where the secret is",
      "hasOptions": false,
      "label": "",
      "name": "namespace",
      "options": [
        {
          "value": ""
        }
      ],
      "pinned": false,
      "required": false
    },
    {
      "default": "gittoken,ldappassword,dbpassword,keystorepassword,rabbitmqpassword,saporpassword,redispassword",
      "description": "kubernetes secrets for the script source, for multiple secrets use comma seperated list",
      "hasOptions": false,
      "label": "",
      "name": "secretname",
      "options": [
        {
          "value": ""
        }
      ],
      "pinned": false,
      "required": false
    },
    {
      "default": "saitejaopsmx",
      "description": "git repo user id",
      "hasOptions": false,
      "label": "",
      "name": "username",
      "options": [
        {
          "value": ""
        }
      ],
      "pinned": false,
      "required": false
    },
    {
      "default": "github.com/opsmx/helm-install-upgrade",
      "description": "fir repo url without protocol",
      "hasOptions": false,
      "label": "",
      "name": "url",
      "options": [
        {
          "value": ""
        }
      ],
      "pinned": false,
      "required": false
    },
    {
      "default": "v3.12.5",
      "description": "ISD version should be same as branch git repo branch",
      "hasOptions": false,
      "label": "",
      "name": "branch",
      "options": [
        {
          "value": ""
        }
      ],
      "pinned": false,
      "required": false
    },
    {
      "default": "byosupgrade.sh",
      "description": "path to script",
      "hasOptions": false,
      "label": "",
      "name": "path",
      "options": [
        {
          "value": "byosupgrade.sh"
        }
      ],
      "pinned": false,
      "required": false
    },
    {
      "default": "quay.io/opsmxpublic/helm-bash:v2",
      "description": "image used by script running container",
      "hasOptions": false,
      "label": "",
      "name": "scriptimage",
      "options": [
        {
          "value": "hashicorp/packer:latest"
        },
        {
          "value": "hashicorp/terraform"
        },
        {
          "value": "mysql:8.0.29"
        },
        {
          "value": "postgres:13-alpine"
        },
        {
          "value": "willhallonline/ansible:latest"
        },
        {
          "value": "bitnami/kubectl:1.22"
        }
      ],
      "pinned": false,
      "required": false
    },
    {
      "default": "version=3.12.9,gitemail=saiteja.katabhatina@opsmx.io",
      "description": "version here is helm chart version, not isd version, environment variables, for multiple key value pairs use comma seperated list",
      "hasOptions": false,
      "label": "",
      "name": "envs",
      "options": [
        {
          "value": ""
        }
      ],
      "pinned": false,
      "required": false
    }
  ],
  "spelEvaluator": "v4",
  "stages": [
    {
      "account": "hiu",
      "alias": "runJob",
      "application": "byos",
      "cloudProvider": "kubernetes",
      "credentials": "hiu",
      "manifest": {
        "apiVersion": "batch/v1",
        "kind": "Job",
        "metadata": {
          "generateName": "byos-hiu-",
          "labels": {
            "app": "byos"
          },
          "namespace": "${parameters.namespace}"
        },
        "spec": {
          "backoffLimit": 2,
          "template": {
            "spec": {
              "containers": [
                {
                  "args": [
                    "set +x\nfor env in $( echo $envs | tr \",\" \"\\n\" )\ndo\necho export $env >> /tmp/environment\ndone\nfor filename in /secret/* \ndo \nvariable=$(echo $filename | sed 's#/# #g' | awk '{print $2}')\necho setting env $variable for $filename \necho export \"$variable\"=$(cat \"$filename\") >> /tmp/environment\ndone\n#cat /tmp/environment\n#cat /repo/\"$path\"\nsource /tmp/environment\ncd /repo/\nchmod +x /repo/\"$path\"\n/repo/\"$path\"\n#sleep 30d"
                  ],
                  "command": [
                    "/bin/bash",
                    "+x",
                    "-c"
                  ],
                  "env": [
                    {
                      "name": "path",
                      "value": "${parameters.path}"
                    },
                    {
                      "name": "envs",
                      "value": "${parameters.envs}"
                    },
                    {
                      "name": "namespace",
                      "value": "${parameters.namespace}"
                    },
                    {
                      "name": "gitusername",
                      "value": "${parameters.username}"
                    }
                  ],
                  "image": "${parameters.scriptimage}",
                  "name": "script",
                  "volumeMounts": [
                    {
                      "mountPath": "/repo",
                      "name": "repo-volume"
                    },
                    {
                      "mountPath": "/secret",
                      "name": "secret-volume"
                    }
                  ]
                }
              ],
              "initContainers": [
                {
                  "args": [
                    "for secret in $(echo $secrets | sed \"s/,/ /g\")\ndo\necho getting $secret\nkubectl -n \"$ns\" get secret \"$secret\" || { echo \"failed getting secret $secret\" ; exit 1; }\nkubectl -n \"$ns\" get secret \"$secret\" -o jsonpath='{.data.*}' | base64 -d > /secret/\"$secret\" \nls -ltr /secret/\"$secret\"\n#cat /secret/\"$secret\"\ndone\n#sleep 30d use for debugging"
                  ],
                  "command": [
                    "/bin/bash",
                    "+x",
                    "-c"
                  ],
                  "env": [
                    {
                      "name": "ns",
                      "value": "${parameters.namespace}"
                    },
                    {
                      "name": "secrets",
                      "value": "${parameters.secretname}"
                    }
                  ],
                  "image": "bitnami/kubectl:1.22",
                  "name": "kube",
                  "volumeMounts": [
                    {
                      "mountPath": "/secret",
                      "name": "secret-volume"
                    }
                  ]
                },
                {
                  "args": [
                    "\nls -ltr /secret/gittoken || { echo \"failed cloning $url\" ; exit 1; }\ngit clone https://\"$username\":\"$(cat /secret/gittoken)\"@\"$url\" -b \"$branch\" /repo\nif [ $? != 0 ]\nthen\n \nexit 1\nfi\nls -lrt /repo"
                  ],
                  "command": [
                    "/bin/sh",
                    "+x",
                    "-c"
                  ],
                  "env": [
                    {
                      "name": "username",
                      "value": "${parameters.username}"
                    },
                    {
                      "name": "url",
                      "value": "${parameters.url}"
                    },
                    {
                      "name": "branch",
                      "value": "${parameters.branch}"
                    }
                  ],
                  "image": "bitnami/kubectl:1.22",
                  "name": "git",
                  "volumeMounts": [
                    {
                      "mountPath": "/secret",
                      "name": "secret-volume"
                    },
                    {
                      "mountPath": "/repo",
                      "name": "repo-volume"
                    }
                  ]
                }
              ],
              "restartPolicy": "Never",
              "serviceAccountName": "byos",
              "volumes": [
                {
                  "emptyDir": {},
                  "name": "secret-volume"
                },
                {
                  "emptyDir": {},
                  "name": "repo-volume"
                }
              ]
            }
          }
        }
      },
      "name": "Run Job (Manifest)",
      "refId": "1",
      "requisiteStageRefIds": [],
      "source": "text",
      "type": "runJobManifest"
    }
  ],
  "triggers": []
}
